<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Generator - Tables</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f9fafc;
        margin: 0;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }

      .order-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .order-table th,
      .order-table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
      }

      .order-table th {
        background: #007bff;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-download,
      .btn-edit,
      .btn-delete {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        margin: 2px;
      }

      .btn-download {
        background: #28a745;
      }
      .btn-edit {
        background: #ffc107;
        color: #222;
      }
      .btn-delete {
        background: #dc3545;
      }

      .btn-download:hover {
        background: #1e7e34;
      }
      .btn-edit:hover {
        background: #e0a800;
      }
      .btn-delete:hover {
        background: #c82333;
      }

      .qr-code canvas {
        width: 80px;
        height: 80px;
      }

      .loading {
        text-align: center;
        color: #888;
        margin-top: 30px;
        font-size: 1.1em;
      }

      /* === POPUP STYLES === */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10;
      }

      .popup-box {
        background: #fff;
        padding: 20px 25px;
        border-radius: 10px;
        width: 320px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .popup-box h3 {
        margin-bottom: 15px;
        color: #333;
      }

      .popup-box input {
        width: 80%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 15px;
      }

      .popup-box button {
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }

      .save-btn {
        background: #007bff;
        color: white;
      }
      .cancel-btn {
        background: #6c757d;
        color: white;
      }
      .yes {
        background: #dc3545;
        color: white;
      }
      .no {
        background: #6c757d;
        color: white;
      }
    </style>
  </head>

  <body>
    <h1>QR Code Generator for Tables</h1>

    <table class="order-table">
      <thead>
        <tr>
          <th>No</th>
          <th>Table Number</th>
          <th>QR Code</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="qrcodeTableBody"></tbody>
    </table>

    <p id="loading" class="loading">Loading tables...</p>

    <!-- Edit Popup -->
    <div class="popup-overlay" id="editPopup">
      <div class="popup-box">
        <h3>Edit Table</h3>
        <input
          type="text"
          id="editNumber"
          placeholder="Enter new table number"
        />
        <br />
        <button class="save-btn" id="saveEdit">Save</button>
        <button class="cancel-btn" id="closeEdit">Cancel</button>
      </div>
    </div>

    <!-- Delete Popup -->
    <div class="popup-overlay" id="deletePopup">
      <div class="popup-box">
        <p>Do you want to delete this table‚Äôs QR code?</p>
        <button class="yes" id="confirmDelete">Yes</button>
        <button class="no" id="closeDelete">No</button>
      </div>
    </div>

    <script>
      const API_URL = "http://127.0.0.1:8000/table/table/onlytable"; // Get tables
      const BASE_ORDER_URL = "http://smartmenu.com"; // Order link

      let currentEditId = null;
      let currentDeleteId = null;

      async function fetchTables() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) throw new Error("Failed to fetch tables");
          const tables = await res.json();
          document.getElementById("loading").style.display = "none";
          generateQRCodes(tables);
        } catch (err) {
          console.error(err);
          document.getElementById("loading").textContent =
            "Error loading tables.";
        }
      }

      function generateQRCodes(tables) {
        const tbody = document.getElementById("qrcodeTableBody");
        tbody.innerHTML = "";

        tables.forEach((table, index) => {
          const tr = document.createElement("tr");
          const qrId = `qr-${table.Table_ID}`;

          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>Table ${table.No_Table}</td>
            <td><div id="${qrId}" class="qr-code"></div></td>
            <td>
              <button class="btn-download" onclick="downloadQR('${qrId}', '${
            table.No_Table
          }')">‚¨á Download</button>
              <button class="btn-edit" onclick="openEditPopup(${
                table.Table_ID
              }, '${table.No_Table}')">‚úè Edit</button>
              <button class="btn-delete" onclick="openDeletePopup(${
                table.Table_ID
              })">üóë Delete</button>
            </td>`;

          tbody.appendChild(tr);

          const qrText = `${BASE_ORDER_URL}/table/${table.Table_ID}`;
          new QRCode(document.getElementById(qrId), {
            text: qrText,
            width: 100,
            height: 100,
          });
        });
      }

      // Download QR
      function downloadQR(qrId, tableNum) {
        const canvas = document.querySelector(`#${qrId} canvas`);
        if (!canvas) return alert("QR not generated yet!");
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `Table_${tableNum}_QR.png`;
        link.click();
      }

      // ===== Edit Popup =====
      function openEditPopup(id, tableNum) {
        currentEditId = id;
        document.getElementById("editNumber").value = tableNum;
        document.getElementById("editPopup").style.display = "flex";
      }

      document.getElementById("closeEdit").onclick = function () {
        document.getElementById("editPopup").style.display = "none";
      };

      document.getElementById("saveEdit").onclick = async function () {
        const newNumber = document.getElementById("editNumber").value.trim();
        if (!newNumber) return alert("Enter a valid table number!");

        try {
          const res = await fetch(
            `http://127.0.0.1:8000/table/table/update_table/${currentEditId}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ No_Table: newNumber }),
            }
          );

          if (!res.ok) throw new Error("Failed to update table");
          alert("Table updated successfully!");
          document.getElementById("editPopup").style.display = "none";
          fetchTables();
        } catch (err) {
          alert("Error updating table.");
          console.error(err);
        }
      };

      // ===== Delete Popup =====
      function openDeletePopup(id) {
        currentDeleteId = id;
        document.getElementById("deletePopup").style.display = "flex";
      }

      document.getElementById("closeDelete").onclick = function () {
        document.getElementById("deletePopup").style.display = "none";
      };

      document.getElementById("confirmDelete").onclick = async function () {
        try {
          const res = await fetch(
            `http://127.0.0.1:8000/table/table/delete_table/${currentDeleteId}`,
            { method: "DELETE" }
          );
          if (!res.ok) throw new Error("Failed to delete table");
          alert("Table deleted successfully!");
          document.getElementById("deletePopup").style.display = "none";
          fetchTables();
        } catch (err) {
          alert("Error deleting table.");
          console.error(err);
        }
      };

      // Run on page load
      fetchTables();
    </script>
  </body>
</html>
