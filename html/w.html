<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Order System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f9f9f9;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 800px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h1,
      h2 {
        text-align: center;
      }

      .section {
        display: none;
        margin-bottom: 20px;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        padding: 8px;
        margin: 5px 0 10px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }

      textarea {
        resize: none;
        height: 60px;
      }

      button {
        background: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }

      button:hover {
        background: #218838;
      }

      .submitBtn {
        margin-top: 10px;
      }

      .productItem {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
      }

      .productItem input,
      .productItem select {
        flex: 1;
      }

      pre {
        background: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }

      #tabs {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }

      #tabs button {
        width: 30%;
        background: #007bff;
      }

      #tabs button.active {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>QR Code Order System</h1>

      <div id="tabs">
        <button class="tabBtn active" data-section="orderSection">
          Place Order
        </button>
        <button class="tabBtn" data-section="paymentSection">Payment</button>
        <button class="tabBtn" data-section="receiptSection">Receipt</button>
      </div>

      <!-- Place Order -->
      <div class="section" id="orderSection" style="display: block">
        <h2>Client Information</h2>
        <input type="text" id="clientName" placeholder="Client Name" />
        <input type="text" id="clientPhone" placeholder="Phone Number" />

        <h2>Order Items</h2>
        <div id="productList"></div>
        <button id="addProductBtn">Add Product</button>

        <h2>Order Type</h2>
        <select id="orderType">
          <option value="Takeaway">Takeaway</option>
          <option value="Dine In">Dine In</option>
          <option value="Reservation">Reservation</option>
        </select>
        <input
          type="number"
          id="tableNumber"
          placeholder="Table Number (if Dine In / Reservation)"
        />

        <section id="reservationSection" style="display: none">
          <h2>Reservation Details</h2>
          <input type="date" id="reservationDate" />
          <input type="time" id="reservationTime" />
          <input
            type="number"
            id="reservationPersons"
            placeholder="Number of Persons"
          />
        </section>

        <button id="nextPaymentBtn" class="submitBtn">Next: Payment</button>
      </div>

      <!-- Payment Section -->
      <div class="section" id="paymentSection">
        <h2>Payment</h2>
        <select id="paymentMethod">
          <option value="Cash">Cash</option>
          <option value="Card">Card</option>
          <option value="Mobile Money">Mobile Money</option>
        </select>
        <button id="payBtn" class="submitBtn">Pay & Place Order</button>
        <pre id="paymentResponse"></pre>
      </div>

      <!-- Receipt Section -->
      <div class="section" id="receiptSection">
        <h2>Receipt</h2>
        <pre id="receiptContent"></pre>
        <button onclick="window.print()">Print Receipt</button>
      </div>
    </div>

    <script>
      // Tabs
      const tabBtns = document.querySelectorAll(".tabBtn");
      const sections = document.querySelectorAll(".section");
      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          sections.forEach((s) => (s.style.display = "none"));
          document.getElementById(btn.dataset.section).style.display = "block";
        });
      });

      // Products
      let products = [];
      async function fetchProducts() {
        try {
          const res = await fetch(
            "http://localhost:8000/product/product/Product"
          );
          products = await res.json();
        } catch (err) {
          console.error(err);
        }
      }

      const productList = document.getElementById("productList");
      const addProductBtn = document.getElementById("addProductBtn");

      addProductBtn.addEventListener("click", () => {
        if (products.length === 0) return alert("No products available!");
        const div = document.createElement("div");
        div.className = "productItem";
        div.innerHTML = `
        <select class="productSelect">
            ${products
              .map(
                (p) =>
                  `<option value="${p.No_Product}">${p.Product_Name}</option>`
              )
              .join("")}
        </select>
        <input type="number" class="productQty" placeholder="Quantity" min="1">
        <button type="button" class="removeBtn">Remove</button>
    `;
        productList.appendChild(div);
        div
          .querySelector(".removeBtn")
          .addEventListener("click", () => div.remove());
      });

      // Show reservation section
      const orderType = document.getElementById("orderType");
      const reservationSection = document.getElementById("reservationSection");
      orderType.addEventListener("change", () => {
        reservationSection.style.display =
          orderType.value === "Reservation" ? "block" : "none";
      });

      // Save order and move to payment
      const nextPaymentBtn = document.getElementById("nextPaymentBtn");
      nextPaymentBtn.addEventListener("click", () => {
        const client = {
          Client_Name: document.getElementById("clientName").value,
          No_Telephone: document.getElementById("clientPhone").value,
        };
        const order = {
          Order_Type: orderType.value,
          No_Table: document.getElementById("tableNumber").value || null,
          Note: "",
          items: Array.from(document.querySelectorAll(".productItem")).map(
            (div) => ({
              No_Product: parseInt(div.querySelector(".productSelect").value),
              Quantity: parseInt(div.querySelector(".productQty").value),
            })
          ),
        };
        let reservation = null;
        if (orderType.value === "Reservation") {
          reservation = {
            No_Table: parseInt(document.getElementById("tableNumber").value),
            Reservation_Date: document.getElementById("reservationDate").value,
            Reservation_Time: document.getElementById("reservationTime").value,
            No_Person: parseInt(
              document.getElementById("reservationPersons").value
            ),
          };
        }
        sessionStorage.setItem(
          "fullOrder",
          JSON.stringify({ client, order, reservation })
        );
        document.querySelector('[data-section="paymentSection"]').click();
      });

      // Payment
      const payBtn = document.getElementById("payBtn");
      const paymentResponse = document.getElementById("paymentResponse");
      payBtn.addEventListener("click", async () => {
        const fullOrder = JSON.parse(sessionStorage.getItem("fullOrder"));
        if (!fullOrder) return alert("No order found.");

        fullOrder.payment = {
          Payment_Method: document.getElementById("paymentMethod").value,
        };

        try {
          const res = await fetch("http://localhost:8000/FullOrderRequest", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(fullOrder),
          });
          const data = await res.json();
          paymentResponse.innerText = JSON.stringify(data, null, 2);
          if (res.ok) {
            sessionStorage.setItem(
              "receipt",
              JSON.stringify({ ...fullOrder, orderResponse: data })
            );
            document.querySelector('[data-section="receiptSection"]').click();
          } else alert("Payment failed: " + data.detail);
        } catch (err) {
          paymentResponse.innerText = "Error: " + err.message;
        }
      });

      // Display receipt
      const receiptContent = document.getElementById("receiptContent");
      function showReceipt() {
        const receiptData = JSON.parse(sessionStorage.getItem("receipt"));
        if (!receiptData) {
          receiptContent.innerText = "No receipt available.";
          return;
        }
        const order = receiptData.order;
        const payment = receiptData.payment;
        const response = receiptData.orderResponse;
        receiptContent.innerText = `
Order ID: ${response.Order_ID}
Client: ${receiptData.client.Client_Name} (${receiptData.client.No_Telephone})
Order Type: ${order.Order_Type}
Table Number: ${order.No_Table || "N/A"}
Items:
${order.items
  .map((i) => ` - Product ID: ${i.No_Product}, Quantity: ${i.Quantity}`)
  .join("\n")}
Payment Method: ${payment.Payment_Method}
Payment Status: Paid
`;
      }
      document
        .querySelector('[data-section="receiptSection"]')
        .addEventListener("click", showReceipt);

      fetchProducts();
    </script>
  </body>
</html>
